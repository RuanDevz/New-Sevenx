#!/bin/bash
# STRIPE MULTI-CONTA - CHECKLIST DE IMPLEMENTAÃ‡ÃƒO
# Este arquivo contÃ©m um checklist completo para implementar a arquitetura

# ============================================================================
# FASE 1: CONFIGURAÃ‡ÃƒO NO STRIPE DASHBOARD
# ============================================================================

echo "ğŸ“‹ FASE 1: CONFIGURAÃ‡ÃƒO NO STRIPE DASHBOARD"
echo ""
echo "CONTA PJ (ANTIGA)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 1. Acessar https://dashboard.stripe.com (conta PJ)"
echo "[ ] 2. Ir para Developers â†’ API Keys"
echo "[ ] 3. Copiar Secret Key (comeÃ§a com sk_test_ ou sk_live_)"
echo "[ ] 4. Salvar como: STRIPE_SECRET_KEY_PJ=sk_test_..."
echo ""
echo "[ ] 5. Criar/Atualizar Webhook"
echo "      â€¢ Developers â†’ Webhooks â†’ Add endpoint"
echo "      â€¢ URL: https://seu-dominio.com/webhook/stripe/pj"
echo "      â€¢ Eventos a selecionar:"
echo "        âœ“ invoice.paid"
echo "        âœ“ invoice.payment_failed"
echo "        âœ“ customer.subscription.deleted"
echo "        âœ“ customer.subscription.updated"
echo "        âœ“ invoice.created"
echo "[ ] 6. Copiar Signing secret e salvar como: STRIPE_WEBHOOK_SECRET_PJ=whsec_..."
echo ""
echo ""
echo "CONTA PF (NOVA)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 7. Acessar https://dashboard.stripe.com (conta PF)"
echo "[ ] 8. Ir para Developers â†’ API Keys"
echo "[ ] 9. Copiar Secret Key"
echo "[ ] 10. Salvar como: STRIPE_SECRET_KEY_PF=sk_test_..."
echo ""
echo "[ ] 11. CRIAR NOVOS PREÃ‡OS em PF"
echo "       â€¢ Ir para Products"
echo "       â€¢ Crie um produto 'VIP Diamond' com preÃ§os:"
echo "         - Diamond Monthly â†’ Copiar Price ID para STRIPE_PRICEID_PF_DIAMOND_MONTHLY"
echo "         - Diamond Annual â†’ Copiar Price ID para STRIPE_PRICEID_PF_DIAMOND_ANNUAL"
echo "       â€¢ Crie um produto 'VIP Lifetime' com:"
echo "         - Lifetime (um-pagamento) â†’ Copiar para STRIPE_PRICEID_PF_LIFETIME"
echo ""
echo "[ ] 12. Criar Webhook para PF"
echo "       â€¢ Developers â†’ Webhooks â†’ Add endpoint"
echo "       â€¢ URL: https://seu-dominio.com/webhook/stripe/pf"
echo "       â€¢ Eventos:"
echo "         âœ“ checkout.session.completed"
echo "         âœ“ invoice.paid"
echo "         âœ“ invoice.payment_failed"
echo "         âœ“ customer.subscription.deleted"
echo "         âœ“ customer.subscription.updated"
echo "         âœ“ invoice.created"
echo "[ ] 13. Copiar Signing secret e salvar como: STRIPE_WEBHOOK_SECRET_PF=whsec_..."
echo ""
echo ""

# ============================================================================
# FASE 2: ARQUIVO .ENV
# ============================================================================

echo "ğŸ“„ FASE 2: CONFIGURAR .ENV"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 14. Abrir arquivo: BACKEND/.env"
echo "[ ] 15. Preencher as variÃ¡veis de STRIPE:"
echo ""
echo "STRIPE_SECRET_KEY_PJ=sk_test_YOUR_PJ_KEY"
echo "STRIPE_WEBHOOK_SECRET_PJ=whsec_YOUR_PJ_SECRET"
echo "STRIPE_SECRET_KEY_PF=sk_test_YOUR_PF_KEY"
echo "STRIPE_WEBHOOK_SECRET_PF=whsec_YOUR_PF_SECRET"
echo "STRIPE_PRICEID_PF_DIAMOND_MONTHLY=price_XXX"
echo "STRIPE_PRICEID_PF_DIAMOND_ANNUAL=price_XXX"
echo "STRIPE_PRICEID_PF_LIFETIME=price_XXX"
echo ""
echo "[ ] 16. Salvar arquivo .env"
echo ""
echo ""

# ============================================================================
# FASE 3: VERIFICAR ARQUIVOS CRIADOS
# ============================================================================

echo "âœ… FASE 3: ARQUIVOS JÃ CRIADOS/ATUALIZADOS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 17. Verificar lib/stripeService.js (âœ… Criado)"
echo "        â€¢ getStripeInstance(operation, context)"
echo "        â€¢ verifyWebhookSignature(body, sig)"
echo "        â€¢ identifySubscriptionAccount(subscriptionId)"
echo "        â€¢ getPriceId(vipTier, planType)"
echo ""
echo "[ ] 18. Verificar routes/payment.js (âœ… Atualizado)"
echo "        â€¢ Importa stripeService"
echo "        â€¢ Usa getStripeInstance('create')"
echo "        â€¢ Usa getPriceId()"
echo "        â€¢ TITANIUM comentado"
echo ""
echo "[ ] 19. Verificar routes/stripewebhook.js (âœ… Atualizado)"
echo "        â€¢ Importa stripeService"
echo "        â€¢ Usa verifyWebhookSignature()"
echo "        â€¢ Detecta conta automaticamente"
echo ""
echo "[ ] 20. Ler documentaÃ§Ã£o:"
echo "        â€¢ STRIPE_ARCHITECTURE.md"
echo "        â€¢ STRIPE_SETUP_GUIDE.md"
echo "        â€¢ STRIPE_INTEGRATION_EXAMPLES.js"
echo ""
echo ""

# ============================================================================
# FASE 4: OUTRAS ROTAS QUE PRECISAM ATUALIZAR
# ============================================================================

echo "ğŸ”§ FASE 4: ROTAS QUE FALTAM ATUALIZAR"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 21. Atualizar routes/Cancelsubscription.js"
echo "        â€¢ Importar stripeService"
echo "        â€¢ Usar identifySubscriptionAccount()"
echo "        â€¢ Selecionar stripe correta (PJ ou PF)"
echo "        â€¢ Exemplo em: STRIPE_INTEGRATION_EXAMPLES.js"
echo ""
echo "[ ] 22. Atualizar routes/Renewvip.js (se existir)"
echo "        â€¢ Importar stripeService"
echo "        â€¢ Usar getStripeInstance('renew')"
echo "        â€¢ Sempre usar stripePF"
echo ""
echo "[ ] 23. Atualizar routes/stripeCustomerPortal.js (se existir)"
echo "        â€¢ Importar stripeService"
echo "        â€¢ Identificar conta do cliente"
echo "        â€¢ Usar stripe correspondente"
echo ""
echo ""

# ============================================================================
# FASE 5: TESTES LOCAIS
# ============================================================================

echo "ğŸ§ª FASE 5: TESTES LOCAIS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 24. Instalar Stripe CLI (se nÃ£o tiver)"
echo "        curl https://files.stripe.com/stripe-cli/install.sh | bash"
echo ""
echo "[ ] 25. Terminal 1: Escutar webhooks PJ"
echo "        stripe listen --forward-to localhost:3000/webhook/stripe/pj"
echo "        â€¢ Copiar signing secret em .env como STRIPE_WEBHOOK_SECRET_PJ"
echo ""
echo "[ ] 26. Terminal 2: Escutar webhooks PF"
echo "        stripe listen --forward-to localhost:3000/webhook/stripe/pf"
echo "        â€¢ Copiar signing secret em .env como STRIPE_WEBHOOK_SECRET_PF"
echo ""
echo "[ ] 27. Terminal 3: Iniciar servidor"
echo "        npm start"
echo ""
echo "[ ] 28. Testar criaÃ§Ã£o de checkout (PF)"
echo "        curl -X POST http://localhost:3000/vip-payment \\
echo "          -H 'Content-Type: application/json' \\
echo "          -d '{\"email\":\"test@example.com\",\"vipTier\":\"diamond\",\"planType\":\"monthly\"}'"
echo ""
echo "[ ] 29. Simular webhook"
echo "        stripe trigger checkout.session.completed"
echo ""
echo "[ ] 30. Verificar logs (deve mostrar 'Conta: PF')"
echo ""
echo ""

# ============================================================================
# FASE 6: TESTES DE CANCELAMENTO
# ============================================================================

echo "âŒ FASE 6: TESTES DE CANCELAMENTO"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 31. Testar cancelamento de assinatura NOVA (PF)"
echo "        â€¢ Criar assinatura em PF"
echo "        â€¢ Cancelar usando subscription ID de PF"
echo "        â€¢ Deve usar stripePF"
echo ""
echo "[ ] 32. Testar cancelamento de assinatura LEGADO (PJ)"
echo "        â€¢ Encontrar subscription ID antigo (PJ)"
echo "        â€¢ Cancelar usando esse ID"
echo "        â€¢ Deve usar stripePJ"
echo ""
echo "[ ] 33. Verificar identifySubscriptionAccount()"
echo "        â€¢ Chamar com sub PF â†’ deve retornar 'pf'"
echo "        â€¢ Chamar com sub PJ â†’ deve retornar 'pj'"
echo ""
echo ""

# ============================================================================
# FASE 7: DEPLOYMENT
# ============================================================================

echo "ğŸš€ FASE 7: DEPLOYMENT"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 34. Verificar variÃ¡veis de ambiente em produÃ§Ã£o"
echo "        â€¢ STRIPE_SECRET_KEY_PJ (production key)"
echo "        â€¢ STRIPE_SECRET_KEY_PF (production key)"
echo "        â€¢ STRIPE_WEBHOOK_SECRET_PJ (production)"
echo "        â€¢ STRIPE_WEBHOOK_SECRET_PF (production)"
echo ""
echo "[ ] 35. Configurar webhooks em produÃ§Ã£o"
echo "        PJ Dashboard: https://seu-dominio-prod.com/webhook/stripe/pj"
echo "        PF Dashboard: https://seu-dominio-prod.com/webhook/stripe/pf"
echo ""
echo "[ ] 36. Copiar signing secrets de produÃ§Ã£o para .env.production"
echo ""
echo "[ ] 37. Deploy em produÃ§Ã£o"
echo "        git push production main"
echo ""
echo "[ ] 38. Verificar logs de webhook em produÃ§Ã£o"
echo "        Deve mostrar 'Conta: pj' ou 'Conta: pf' dependendo do evento"
echo ""
echo ""

# ============================================================================
# FASE 8: MONITORAMENTO
# ============================================================================

echo "ğŸ“Š FASE 8: MONITORAMENTO"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "[ ] 39. Monitorar logs de webhook"
echo "        tail -f /var/log/app.log | grep WEBHOOK"
echo ""
echo "[ ] 40. Verificar eventos no Stripe Dashboard"
echo "        PJ: Developers â†’ Webhooks â†’ Events (deve ver legacy events)"
echo "        PF: Developers â†’ Webhooks â†’ Events (deve ver novos events)"
echo ""
echo "[ ] 41. Alertas para erros"
echo "        â€¢ Webhook signature invÃ¡lida"
echo "        â€¢ Subscription not found"
echo "        â€¢ Price not configured"
echo ""
echo "[ ] 42. Testar migraÃ§Ã£o de cliente (se necessÃ¡rio)"
echo "        â€¢ Cancelar em PJ"
echo "        â€¢ Criar em PF"
echo "        â€¢ Marcar user.stripeAccountOrigin = 'pf'"
echo ""
echo ""

# ============================================================================
# RESUMO FINAL
# ============================================================================

echo "âœ¨ RESUMO FINAL"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Total de itens: 42"
echo ""
echo "Quando este checklist estiver completo, vocÃª terÃ¡:"
echo "âœ… Duas contas Stripe funcionando em paralelo"
echo "âœ… PJ para assinaturas legadas (apenas webhooks e cancelamento)"
echo "âœ… PF para novas assinaturas (criaÃ§Ã£o, renovaÃ§Ã£o, webhooks)"
echo "âœ… Sistema que detecta automaticamente qual conta usar"
echo "âœ… Webhooks separados funcionando corretamente"
echo "âœ… CÃ³digo pronto para produÃ§Ã£o"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "DÃºvidas? Ver:"
echo "  â€¢ STRIPE_ARCHITECTURE.md"
echo "  â€¢ STRIPE_SETUP_GUIDE.md"
echo "  â€¢ STRIPE_INTEGRATION_EXAMPLES.js"
echo ""
